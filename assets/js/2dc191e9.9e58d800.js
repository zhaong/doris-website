"use strict";(self.webpackChunkdoris_website=self.webpackChunkdoris_website||[]).push([[954393],{15680:(e,t,a)=>{a.d(t,{xA:()=>u,yg:()=>m});var n=a(296540);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function l(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function o(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var s=n.createContext({}),p=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):l(l({},t),e)),a},u=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},d="mdxType",g={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},c=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),d=p(a),c=r,m=d["".concat(s,".").concat(c)]||d[c]||g[c]||i;return a?n.createElement(m,l(l({ref:t},u),{},{components:a})):n.createElement(m,l({ref:t},u))}));function m(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=a.length,l=new Array(i);l[0]=c;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o[d]="string"==typeof e?e:r,l[1]=o;for(var p=2;p<i;p++)l[p]=a[p];return n.createElement.apply(null,l)}return n.createElement.apply(null,a)}c.displayName="MDXCreateElement"},966667:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>l,default:()=>g,frontMatter:()=>i,metadata:()=>o,toc:()=>p});var n=a(58168),r=(a(296540),a(15680));const i={title:"Java UDF, UDAF, UDTF",language:"en"},l=void 0,o={unversionedId:"query-data/udf/java-user-defined-function",id:"query-data/udf/java-user-defined-function",title:"Java UDF, UDAF, UDTF",description:"\x3c!--",source:"@site/docs/query-data/udf/java-user-defined-function.md",sourceDirName:"query-data/udf",slug:"/query-data/udf/java-user-defined-function",permalink:"/docs/dev/query-data/udf/java-user-defined-function",draft:!1,tags:[],version:"current",frontMatter:{title:"Java UDF, UDAF, UDTF",language:"en"},sidebar:"docs",previous:{title:"Alias Function",permalink:"/docs/dev/query-data/udf/alias-function"},next:{title:"Complex Type",permalink:"/docs/dev/query-data/complex-type"}},s={},p=[{value:"Overview",id:"overview",level:2},{value:"Type Correspondence",id:"type-correspondence",level:2},{value:"Usage Notes",id:"usage-notes",level:2},{value:"Getting Started",id:"getting-started",level:2},{value:"Introduction to Java-UDF Example",id:"introduction-to-java-udf-example",level:3},{value:"Introduction to Java-UDAF Example",id:"introduction-to-java-udaf-example",level:3},{value:"Introduction to Java-UDTF Example",id:"introduction-to-java-udtf-example",level:3},{value:"Best Practices",id:"best-practices",level:2}],u={toc:p},d="wrapper";function g(e){let{components:t,...a}=e;return(0,r.yg)(d,(0,n.A)({},u,a,{components:t,mdxType:"MDXLayout"}),(0,r.yg)("h2",{id:"overview"},"Overview"),(0,r.yg)("p",null,'Java UDF provides a Java interface for users to implement user-defined functions (UDFs) conveniently using the Java programming language.\nDoris supports the use of Java to develop UDFs, UDAFs, and UDTFs. Unless otherwise specified, "UDF" in the following text refers to all types of user-defined functions.'),(0,r.yg)("ol",null,(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},"Java UDF: A Java UDF is a commonly used scalar function, where each input row produces a corresponding output row. Common examples include ABS and LENGTH. Notably, Hive UDFs can be directly migrated to Doris, which is convenient for users.")),(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},"Java UDAF: A Java UDAF is a user-defined aggregate function that aggregates multiple input rows into a single output row. Common examples include MIN, MAX, and COUNT.")),(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},"Java UDTF: A Java UDTF is a user-defined table function, where a single input row can generate one or multiple output rows. In Doris, UDTFs must be used with Lateral View to achieve row-to-column transformations. Common examples include EXPLODE and EXPLODE_SPLIT."))),(0,r.yg)("h2",{id:"type-correspondence"},"Type Correspondence"),(0,r.yg)("table",null,(0,r.yg)("thead",{parentName:"table"},(0,r.yg)("tr",{parentName:"thead"},(0,r.yg)("th",{parentName:"tr",align:null},"Type"),(0,r.yg)("th",{parentName:"tr",align:null},"UDF Argument Type"))),(0,r.yg)("tbody",{parentName:"table"},(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"Bool"),(0,r.yg)("td",{parentName:"tr",align:null},"Boolean")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"TinyInt"),(0,r.yg)("td",{parentName:"tr",align:null},"Byte")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"SmallInt"),(0,r.yg)("td",{parentName:"tr",align:null},"Short")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"Int"),(0,r.yg)("td",{parentName:"tr",align:null},"Integer")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"BigInt"),(0,r.yg)("td",{parentName:"tr",align:null},"Long")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"LargeInt"),(0,r.yg)("td",{parentName:"tr",align:null},"BigInteger")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"Float"),(0,r.yg)("td",{parentName:"tr",align:null},"Float")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"Double"),(0,r.yg)("td",{parentName:"tr",align:null},"Double")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"Date"),(0,r.yg)("td",{parentName:"tr",align:null},"LocalDate")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"Datetime"),(0,r.yg)("td",{parentName:"tr",align:null},"LocalDateTime")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"String"),(0,r.yg)("td",{parentName:"tr",align:null},"String")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"Decimal"),(0,r.yg)("td",{parentName:"tr",align:null},"BigDecimal")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"array<Type>")),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"ArrayList<Type>"))),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"map<Type1,Type2>")),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"HashMap<Type1,Type2>"))),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"struct<Type...>")),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"ArrayList<Object>")," (from version 3.0.0)")))),(0,r.yg)("admonition",{type:"tip"},(0,r.yg)("p",{parentName:"admonition"},(0,r.yg)("inlineCode",{parentName:"p"},"array/map/struct")," types can be nested with other types. For instance, Doris: ",(0,r.yg)("inlineCode",{parentName:"p"},"array<array<int>>")," corresponds to JAVA UDF Argument Type: ",(0,r.yg)("inlineCode",{parentName:"p"},"ArrayList<ArrayList<Integer>>"),". Other types follow the same pattern.")),(0,r.yg)("admonition",{title:"Warning",type:"caution"},(0,r.yg)("p",{parentName:"admonition"},"When creating functions, avoid using ",(0,r.yg)("inlineCode",{parentName:"p"},"varchar")," in place of ",(0,r.yg)("inlineCode",{parentName:"p"},"string"),", as this may cause the function to fail.")),(0,r.yg)("h2",{id:"usage-notes"},"Usage Notes"),(0,r.yg)("ol",null,(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},"Complex data types (HLL, Bitmap) are not supported.")),(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},"Users are currently allowed to specify the maximum JVM heap size. The configuration item is the ",(0,r.yg)("inlineCode",{parentName:"p"},"-Xmx")," part of ",(0,r.yg)("inlineCode",{parentName:"p"},"JAVA_OPTS")," in ",(0,r.yg)("inlineCode",{parentName:"p"},"be.conf"),". The default is 1024m. If you need to aggregate data, it is recommended to increase this value to enhance performance and reduce the risk of memory overflow.")),(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},"Due to issues with JVM loading classes with the same name, do not use multiple classes with the same name as UDF implementations simultaneously. If you want to update a UDF with a class of the same name, you need to restart BE to reload the classpath."))),(0,r.yg)("h2",{id:"getting-started"},"Getting Started"),(0,r.yg)("p",null,"This section mainly introduces how to develop a Java UDF. Examples are provided in ",(0,r.yg)("inlineCode",{parentName:"p"},"samples/doris-demo/java-udf-demo/")," for reference. Click ",(0,r.yg)("a",{parentName:"p",href:"https://github.com/apache/doris/tree/master/samples/doris-demo/java-udf-demo"},"here")," to view details."),(0,r.yg)("p",null,"The usage of UDFs is identical to standard functions, with the primary distinction being that built-in functions have a global scope, while UDFs are scoped within the DB."),(0,r.yg)("p",null,"When the session is linked within the database, directly using the UDF name will search for the corresponding UDF within the current DB. Otherwise, users must explicitly specify the UDF's database name, for example, ",(0,r.yg)("inlineCode",{parentName:"p"},"dbName.funcName"),"."),(0,r.yg)("p",null,"In the following sections, examples will use the table ",(0,r.yg)("inlineCode",{parentName:"p"},"test_table"),". The corresponding table creation script is as follows:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-sql"},'CREATE TABLE `test_table` (\n    id int NULL,\n    d1 double NULL,\n    str string NULL\n) ENGINE=OLAP\nDUPLICATE KEY(`id`)\nDISTRIBUTED BY HASH(`id`) BUCKETS 1\nPROPERTIES (\n"replication_num" = "1");\n\ninsert into test_table values (1, 111.11, "a,b,c");\ninsert into test_table values (6, 666.66, "d,e");\n')),(0,r.yg)("h3",{id:"introduction-to-java-udf-example"},"Introduction to Java-UDF Example"),(0,r.yg)("p",null,"When writing a UDF in Java, the main entry point must be the ",(0,r.yg)("inlineCode",{parentName:"p"},"evaluate")," function. This is consistent with other engines like Hive. In this example, we write an ",(0,r.yg)("inlineCode",{parentName:"p"},"AddOne")," UDF to perform an increment operation on integer inputs."),(0,r.yg)("ol",null,(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},"Write the corresponding Java code and package it into a JAR file."),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-java"},"public class AddOne extends UDF {\n    public Integer evaluate(Integer value) {\n        return value == null ? null : value + 1;\n    }\n}\n"))),(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},"Register and create the Java-UDF function in Doris. For more details on the syntax, refer to ",(0,r.yg)("a",{parentName:"p",href:"/docs/dev/sql-manual/sql-statements/Data-Definition-Statements/Create/CREATE-FUNCTION"},"CREATE FUNCTION"),"."),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-sql"},'CREATE FUNCTION java_udf_add_one(int) RETURNS int PROPERTIES (\n    "file"="file:///path/to/java-udf-demo-jar-with-dependencies.jar",\n    "symbol"="org.apache.doris.udf.AddOne",\n    "always_nullable"="true",\n    "type"="JAVA_UDF"\n);\n'))),(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},"To utilize UDFs, users must possess the ",(0,r.yg)("inlineCode",{parentName:"p"},"SELECT")," privilege for the corresponding database. And to verify the successful registration of the UDF, you can use the ",(0,r.yg)("a",{parentName:"p",href:"/docs/dev/sql-manual/sql-statements/Show-Statements/SHOW-FUNCTIONS"},"SHOW FUNCTIONS")," command."),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-sql"},"select id,java_udf_add_one(id) from test_table;\n+------+----------------------+\n| id   | java_udf_add_one(id) |\n+------+----------------------+\n|    1 |                    2 |\n|    6 |                    7 |\n+------+----------------------+\n"))),(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},"If a UDF is no longer needed, it can be dropped using the following command, as detailed in ",(0,r.yg)("a",{parentName:"p",href:"../../sql-manual/sql-statements/Data-Definition-Statements/Drop/DROP-FUNCTION"},"DROP FUNCTION"),"."))),(0,r.yg)("p",null,"Additionally, if your UDF requires loading large resource files or defining global static variables, you can refer to the method for loading static variables described later in this document."),(0,r.yg)("h3",{id:"introduction-to-java-udaf-example"},"Introduction to Java-UDAF Example"),(0,r.yg)("p",null,"When writing a ",(0,r.yg)("inlineCode",{parentName:"p"},"UDAF")," using Java, there are some functions that must be implemented (marked as required) along with an internal class State. The following example will illustrate how to implement them."),(0,r.yg)("ol",null,(0,r.yg)("li",{parentName:"ol"},"Write the corresponding Java UDAF code and package it into a JAR file.")),(0,r.yg)("details",null,(0,r.yg)("summary",null," Example 1: SimpleDemo will implement a simple function similar to sum, where the input parameter is INT and the output parameter is INT."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-java"},'package org.apache.doris.udf;\n\nimport java.io.DataInputStream;\nimport java.io.DataOutputStream;\nimport java.io.IOException;\nimport java.util.logging.Logger;\n\npublic class SimpleDemo  {\n\n    Logger log = Logger.getLogger("SimpleDemo");\n\n    //Need an inner class to store data\n    /*required*/\n    public static class State {\n        /*some variables if you need */\n        public int sum = 0;\n    }\n\n    /*required*/\n    public State create() {\n        /* here could do some init work if needed */\n        return new State();\n    }\n\n    /*required*/\n    public void destroy(State state) {\n        /* here could do some destroy work if needed */\n    }\n\n    /*Not Required*/\n    public void reset(State state) {\n        /*if you want this udaf function can work with window function.*/\n        /*Must impl this, it will be reset to init state after calculate every window frame*/\n        state.sum = 0;\n    }\n\n    /*required*/\n    //first argument is State, then other types your input\n    public void add(State state, Integer val) throws Exception {\n        /* here doing update work when input data*/\n        if (val != null) {\n            state.sum += val;\n        }\n    }\n\n    /*required*/\n    public void serialize(State state, DataOutputStream out) throws Exception {\n        /* serialize some data into buffer */\n        out.writeInt(state.sum);\n    }\n\n    /*required*/\n    public void deserialize(State state, DataInputStream in) throws Exception {\n        /* deserialize get data from buffer before you put */\n        int val = in.readInt();\n        state.sum = val;\n    }\n\n    /*required*/\n    public void merge(State state, State rhs) throws Exception {\n        /* merge data from state */\n        state.sum += rhs.sum;\n    }\n\n    /*required*/\n    //return Type you defined\n    public Integer getValue(State state) throws Exception {\n        /* return finally result */\n        return state.sum;\n    }\n}\n'))),(0,r.yg)("details",null,(0,r.yg)("summary",null," Example 2: MedianUDAF is a function that calculates the median. The input types are (DOUBLE, INT), and the output type is DOUBLE. "),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-java"},'package org.apache.doris.udf.demo;  \n\nimport java.io.DataInputStream;  \nimport java.io.DataOutputStream;\nimport java.io.IOException;\nimport java.math.BigDecimal;  \nimport java.util.Arrays;  \nimport java.util.logging.Logger;  \n\n/* UDAF to calculate the median */  \npublic class MedianUDAF {  \n    Logger log = Logger.getLogger("MedianUDAF");  \n\n    // State storage  \n    public static class State {  \n        // Precision of the return result  \n        int scale = 0;  \n        // Whether it is the first time to execute the add method for a certain aggregation condition under a certain tablet  \n        boolean isFirst = true;  \n        // Data storage  \n        public StringBuilder stringBuilder;  \n    }  \n\n    // Initialize the state  \n    public State create() {  \n        State state = new State();  \n        // Pre-initialize based on the amount of data that needs to be aggregated under each aggregation condition of each tablet to increase performance  \n        state.stringBuilder = new StringBuilder(1000);  \n        return state;  \n    }  \n\n    // Process each data under respective aggregation conditions for each tablet  \n    public void add(State state, Double val, int scale) {  \n        if (val != null && state.isFirst) {  \n            state.stringBuilder.append(scale).append(",").append(val).append(",");  \n            state.isFirst = false;  \n        } else if (val != null) {  \n            state.stringBuilder.append(val).append(",");  \n        }  \n    }  \n\n    // Data needs to be output for aggregation after processing  \n    public void serialize(State state, DataOutputStream out) throws IOException {  \n        // Currently, only DataOutputStream is provided. If serialization of objects is required, methods such as concatenating strings, converting to JSON, or serializing into byte arrays can be considered  \n        // If the State object needs to be serialized, it may be necessary to implement a serialization interface for the State inner class  \n        // Ultimately, everything needs to be transmitted via DataOutputStream  \n        out.writeUTF(state.stringBuilder.toString());  \n    }  \n\n    // Obtain the output data from the data processing execution unit  \n    public void deserialize(State state, DataInputStream in) throws IOException {  \n        String string = in.readUTF();  \n        state.scale = Integer.parseInt(String.valueOf(string.charAt(0)));  \n        StringBuilder stringBuilder = new StringBuilder(string.substring(2));  \n        state.stringBuilder = stringBuilder;   \n    }  \n\n    // The aggregation execution unit merges the processing results of data under certain aggregation conditions for a given key. The state1 parameter is the initialized instance during the first merge of each key  \n    public void merge(State state1, State state2) {  \n        state1.scale = state2.scale;  \n        state1.stringBuilder.append(state2.stringBuilder.toString());  \n    }  \n\n    // Output the final result after merging the data for each key  \n    public Double getValue(State state) {  \n        String[] strings = state.stringBuilder.toString().split(",");  \n        double[] doubles = new double[strings.length];  \n        for (int i = 0; i < strings.length - 1; i++) {  \n            doubles[i] = Double.parseDouble(strings[i + 1]);  \n        }  \n\n        Arrays.sort(doubles);  \n        double n = doubles.length;  \n        if (n == 0) {  \n            return 0.0;  \n        }  \n        double index = (n - 1) / 2.0;  \n\n        int low = (int) Math.floor(index);  \n        int high = (int) Math.ceil(index);  \n\n        double value = low == high ? (doubles[low] + doubles[high]) / 2 : doubles[high];  \n\n        BigDecimal decimal = new BigDecimal(value);  \n        return decimal.setScale(state.scale, BigDecimal.ROUND_HALF_UP).doubleValue();  \n    }  \n\n    // Executed after each execution unit completes  \n    public void destroy(State state) {  \n    }  \n}\n'))),(0,r.yg)("ol",{start:2},(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},"Register and create the Java-UDAF function in Doris. For more syntax details, please refer to ",(0,r.yg)("a",{parentName:"p",href:"/docs/dev/sql-manual/sql-statements/Data-Definition-Statements/Create/CREATE-FUNCTION"},"CREATE FUNCTION"),"."),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-sql"},'CREATE AGGREGATE FUNCTION simple_demo(INT) RETURNS INT PROPERTIES (\n    "file"="file:///pathTo/java-udaf.jar",\n    "symbol"="org.apache.doris.udf.SimpleDemo",\n    "always_nullable"="true",\n    "type"="JAVA_UDF"\n);\n'))),(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},"When using Java-UDAF, you can perform aggregation either by grouping or by aggregating all results:"),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-sql"},"select simple_demo(id) from test_table group by id;\n+-----------------+\n| simple_demo(id) |\n+-----------------+\n|               1 |\n|               6 |\n+-----------------+\n")),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-sql"},"select simple_demo(id) from test_table;\n+-----------------+\n| simple_demo(id) |\n+-----------------+\n|               7 |\n+-----------------+\n")))),(0,r.yg)("h3",{id:"introduction-to-java-udtf-example"},"Introduction to Java-UDTF Example"),(0,r.yg)("admonition",{type:"tip"},(0,r.yg)("p",{parentName:"admonition"},"UDTF is supported starting from Doris version 3.0.")),(0,r.yg)("ol",null,(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},"Similar to UDFs, UDTFs require users to implement an ",(0,r.yg)("inlineCode",{parentName:"p"},"evaluate")," method. However, the return value of a UDTF must be of the Array type."),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-JAVA"},"public class UDTFStringTest {\n    public ArrayList<String> evaluate(String value, String separator) {\n        if (value == null || separator == null) {\n            return null;\n        } else {\n            return new ArrayList<>(Arrays.asList(value.split(separator)));\n        }\n    }\n}\n"))),(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},"Register and create the Java-UDTF function in Doris. Two UDTF functions will be registered. Table functions in Doris may exhibit different behaviors due to the ",(0,r.yg)("inlineCode",{parentName:"p"},"_outer")," suffix. For more details, refer to ",(0,r.yg)("a",{parentName:"p",href:"/docs/dev/sql-manual/sql-functions/table-functions/explode-numbers-outer"},"OUTER combinator"),".\nFor more syntax details, please refer to ",(0,r.yg)("a",{parentName:"p",href:"/docs/dev/sql-manual/sql-statements/Data-Definition-Statements/Create/CREATE-FUNCTION"},"CREATE FUNCTION"),"."),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre"},'```sql\nCREATE TABLES FUNCTION java-utdf(string, string) RETURNS array<string> PROPERTIES (\n    "file"="file:///pathTo/java-udaf.jar",\n    "symbol"="org.apache.doris.udf.demo.UDTFStringTest",\n    "always_nullable"="true",\n    "type"="JAVA_UDF"\n);\n```\n'))),(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},"When using Java-UDTF, in Doris, UDTFs must be used with ",(0,r.yg)("a",{parentName:"p",href:"/docs/dev/query-data/lateral-view"},(0,r.yg)("inlineCode",{parentName:"a"},"Lateral View"))," to achieve the row-to-column transformation effect:"),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-sql"},"select id, str, e1 from test_table lateral view java_utdf(str,',') tmp as e1;\n+------+-------+------+\n| id   | str   | e1   |\n+------+-------+------+\n|    1 | a,b,c | a    |\n|    1 | a,b,c | b    |\n|    1 | a,b,c | c    |\n|    6 | d,e   | d    |\n|    6 | d,e   | e    |\n+------+-------+------+\n")))),(0,r.yg)("h2",{id:"best-practices"},"Best Practices"),(0,r.yg)("p",null,(0,r.yg)("em",{parentName:"p"},"Loading static variables")),(0,r.yg)("p",null,"Currently, in Doris, executing a UDF function, e.g., ",(0,r.yg)("inlineCode",{parentName:"p"},"select udf(col) from table"),", will load the udf.jar package for each concurrent instance, and unload the udf.jar package when the instance finish. "),(0,r.yg)("p",null,"If the udf.jar file needs to load a file of several hundred MBs, the memory usage will increase sharply due to concurrency, potentially leading to OOM (Out of Memory)."),(0,r.yg)("p",null,"Alternatively, if you want to use a connection pool, this approach will not allow you to initialize it only once in the static area."),(0,r.yg)("p",null,"Here are two solutions, with the second solution requiring Doris version branch-3.0 or above."),(0,r.yg)("p",null,(0,r.yg)("em",{parentName:"p"},"Solution 1:")),(0,r.yg)("p",null,"The solution is to split the resource loading code, generate a separate jar package, and have other packages directly reference this resource jar package."),(0,r.yg)("p",null,"Assume the files have been split into ",(0,r.yg)("inlineCode",{parentName:"p"},"DictLibrary")," and ",(0,r.yg)("inlineCode",{parentName:"p"},"FunctionUdfAR"),"."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-java"},'public class DictLibrary {\n    private static HashMap<String, String> res = new HashMap<>();\n\n    static {\n        // suppose we built this dictionary from a certain local file.\n        res.put("key1", "value1");\n        res.put("key2", "value2");\n        res.put("key3", "value3");\n        res.put("0", "value4");\n        res.put("1", "value5");\n        res.put("2", "value6");\n    }\n\n    public static String evaluate(String key) {\n        if (key == null) {\n            return null;\n        }\n        return res.get(key);\n    }\n}\n')),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-java"},"public class FunctionUdf {\n    public String evaluate(String key) {\n        String value = DictLibrary.evaluate(key);\n        return value;\n    }\n}\n")),(0,r.yg)("ol",null,(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},"Compile the DictLibrary file separately to generate an independent jar package, resulting in a resource file DictLibrary.jar:"),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-shell"},"javac ./DictLibrary.java\njar -cf ./DictLibrary.jar ./DictLibrary.class\n"))),(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},"Then compile the FunctionUdf file, directly referencing the resource package from the previous step, resulting in the FunctionUdf.jar package:"),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-shell"},"javac -cp ./DictLibrary.jar ./FunctionUdf.java\njar -cvf ./FunctionUdf.jar ./FunctionUdf.class\n"))),(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},"After the above two steps, you will get two jar packages. To allow the resource jar package to be referenced by all concurrent instances, place it in the deployment path ",(0,r.yg)("inlineCode",{parentName:"p"},"be/custom_lib"),". After the restarting, it will be loaded with the JVM startup. As a result, the resources will be loaded when the service starts and released when the service stops.")),(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},"Finally, use the ",(0,r.yg)("inlineCode",{parentName:"p"},"create function")," statement to create a UDF function"),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-sql"},'CREATE FUNCTION java_udf_dict(string) RETURNS string PROPERTIES (\n "file"="file:///pathTo/FunctionUdf.jar",\n "symbol"="org.apache.doris.udf.FunctionUdf",\n "always_nullable"="true",\n "type"="JAVA_UDF"\n);\n')))),(0,r.yg)("p",null,(0,r.yg)("em",{parentName:"p"},"Solution 2:")),(0,r.yg)("p",null,"The BE (Backend) globally caches the JAR file and customizes the expiration and eviction time. When creating a function, two additional properties are added:"),(0,r.yg)("p",null,"static_load: This defines whether to use the static cache loading method.\nexpiration_time: This defines the expiration time of the JAR file, in minutes.\nIf the static cache loading method is used, the UDF instance will be cached after the first call and initialization. On subsequent calls to the UDF, the system will first search in the cache. If not found, the initialization process will be triggered."),(0,r.yg)("p",null,"Additionally, a background thread regularly checks the cache. If the function has not been called within the configured expiration time, it will be evicted from the cache. If the function is called, the cache timestamp will be automatically updated."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-sql"},"public class Print extends UDF {\n    static Integer val = 0;\n    public Integer evaluate() {\n        val = val + 1;\n        return val;\n    }\n}\n")),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-sql"},'CREATE FUNCTION print_12() RETURNS int \nPROPERTIES (\n    "file" = "file:///path/to/java-udf-demo-jar-with-dependencies.jar",\n    "symbol" = "org.apache.doris.udf.Print", \n    "always_nullable"="true",\n    "type" = "JAVA_UDF",\n    "static_load" = "true", // default value is false\n    "expiration_time" = "60" // default value is 360 minutes\n);\n')),(0,r.yg)("p",null,"As we can see, the result keeps incrementing, which proves that the loaded JAR file is not being unloaded and reloaded. Instead, the variables are being re-initialized to 0."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-sql"},"mysql [test_query_qa]>select print_12();\n+------------+\n| print_12() |\n+------------+\n|          1 |\n+------------+\n1 row in set (0.40 sec)\n\nmysql [test_query_qa]>select print_12();\n+------------+\n| print_12() |\n+------------+\n|          2 |\n+------------+\n1 row in set (0.03 sec)\n\nmysql [test_query_qa]>select print_12();\n+------------+\n| print_12() |\n+------------+\n|          3 |\n+------------+\n1 row in set (0.04 sec)\n\n")))}g.isMDXComponent=!0}}]);